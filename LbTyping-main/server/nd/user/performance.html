<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Database Viewer</title>
<script src="https://www.w3schools.com/lib/w3.js"></script>
</head>
<style>
.child {
  display: inline;
}

/* 共通設定 */
.child {
  color: #fff;
  text-align: center;
  line-height: 100px;
  width: 100px;
  height: 100px;
  background-color: #777;
}

.sorttbl{
    border-collapse: collapse;
    border-spacing: 0;
    width: 100%;
    display: table;
}
.sorttbl tr {
    display: table-row;
    vertical-align: inherit;
    border-color: inherit;
    border-bottom: 1px solid #ddd;
    cursor: pointer;
}

.sorttbl th:first-child,
.sorttbl td:first-child{
    padding-left: 16px;
}
.sorttbl td,
.sorttbl th{
    padding: 8px 8px;
    display: table-cell;
    text-align: left;
    vertical-align: top;
}
.sorttbl th{
    color: #fff!important;
    background-color: #616161!important;
}

/*--- list css ---*/

.sort-btn{
    border: none;
    display: inline-block;
    padding: 8px 16px;
    vertical-align: middle;
    overflow: hidden;
    text-decoration: none;
    color: #FFFFFF;
    background-color: #4CAF50;
    text-align: center;
    cursor: pointer;
    white-space: nowrap;
}

ul.sortlist{
    list-style-type: none;
}
ul.sortlist li{
    padding: 7px;
    border-bottom: dotted 1px #454545;
}
table {
	border-collapse: collapse;
}
.price caption {
	color: #orange;
}
table th, td {
	border: 1px solid #e3ecf5;
	padding: 8px;
}
table th {
	border: 1px solid #e3ecf5;
	color: #fff;
	background: #1f8ef5;
}
table tr:nth-child(odd) {
	background: #e3ecf5;
}
</style>
<script type="text/javascript">
function random() {
var num = Math.floor( Math.random() * 10 + 1 ) ; //乱数の取得
 var uuid = "", i, random;
  for (i = 0; i < 32; i++) {
    random = Math.random() * 16 | 0;

    if (i == 8 || i == 12 || i == 16 || i == 20) {
      uuid += "-"
    }
    uuid += (i == 12 ? 4 : (i == 16 ? (random & 3 | 8) : random)).toString(16);
  }
  num=uuid;




document.getElementById("ransuu").innerHTML = num; //乱数の出力
}/*あなたの学生番号<div id="sid"></div>*/
</script>
<body>
<h1>実績確認</h1>

<span>あなたの学生番号 </span><span id="si" name="sid"></span><span id="sid" name="sid"></span>
<div id="today" name="today"></div>
<form><input type="text" name="sd" id="sd"  size="10"><form><input type="button" value="日付検索" onClick="kensaku()"><input type="button" value="今日の解答を表示" onclick="showResponseByDay()"><input type="button" value="今までの解答を表示" onclick="showResponseByStudent()"><input type="button" value="最新の３件" onclick="kouzyun()"><br>
<form><input type="button" value="提出ID生成" onClick="random()"><span id="ransuu"></span></form>
<input type="button" value="clear" onclick="clearResult()"><br>
<hr>
<div id="result"></div>
<p>最後までタイプした課題のみを表示しています。</p>
<hr>
<button type="button" id="c_page" onclick="location.href= 'choice.html'" style="font-size: 30px;  width:300px; height:100px; position: relative; top: 50px; display: inline-block; left: 200px;margin: 0 auto">問題選択画面へ</button>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
// グローバル変数（いくつかの関数内で参照・更新する）
let sid = null;
let res_data = null; // query呼び出しで格納
let hist = null; // setupHist呼び出しで格納
const origin_id = 'origin'
const sid_id = 'sid';
const qid_id = 'qid';
const rid_id = 'rid';
const miss_id = 'miss';
const note_id = 'note';
let null_string = '&nbsp;'
const flag_show_result = true;
// オリジンの変更


// pathに基づきサーバに問い合わせる
const query = async (path) => {
  const origin = 'http://localhost:21337'
  let res = await axios.get(origin + path);
  res_data = res.data;
  if (flag_show_result) {
   
  }
}




//今日の日付を表示する関数
const todaytable=()=>{
var hiduke=new Date(); 

//年・月・日・曜日を取得する
var year = hiduke.getFullYear();
var month = hiduke.getMonth()+1;
var week = hiduke.getDay();
var day = hiduke.getDate();
var yobi= new Array("日","月","火","水","木","金","土");
var to=year+'年'+month+'月'+day+'日';
document.getElementById('today').innerHTML =to;
}


const showResponseDayTable = () => {
clearResult();
  const a = (res_data instanceof Array) ? res_data : [res_data];
  let table = '<div style="height:300px; width:2000px; overflow-y:scroll; overflow-:scroll;"><br><table border="1""><tr><th scope="col">日付</th><th scope="col">問題</th><th scope="col" align="right">誤タイプ数</th><th scope="col">解答時間</th></tr>';

  a.forEach((s) => {
    let line = '<tr class="item">';
  
    line += '<td>' + toshiString(s.finish_at) +" "+ tString(s.start_at)+'</td>';
	if(s.question_id==500)
	{
	line += '<td>No.1 Hello</td>';
	}
	if(s.question_id==501)
	{
	line += '<td>No.2 Pangram</td>';
	}
	if(s.question_id==502)
	{
	line += '<td>No.3 Even-Odd</td>';
	}
	if(s.question_id==503)
	{
	line += '<td>No.4 Ten Times</td>';
	}
	if(s.question_id==504)
	{
	line += '<td>No.5 Maximum</td>';
	}
	if(s.question_id==505)
	{
	line += '<td>No.6 Triangle Area</td>';
	}
	if(s.question_id==506)
	{
	line += '<td>No.7 Exponent</td>';
	}


    line += '<td align="right">' + s.miss_count + '</td>';
    line += '<td>' + worktimeString(s.start_at, s.finish_at) + '</td>';

    line += '</tr>';
    table += line;
  });
  table += '<table></div>'
  document.getElementById('result').innerHTML += table;}

// res_dataの値に基づき表を作成するdocument.getElementById('sid').innerHTML='sid';
// red_dataは，responseテーブルまたはその配列のJavaScriptオブジェクト
const showResponseTable = () => {
clearResult();
  const a = (res_data instanceof Array) ? res_data : [res_data];
    var i=0;
  var narabi=[];
  let table = '<div style="height:300px; width:2000px; overflow-y:scroll; overflow-:scroll;"><br><table border="1"><tr><th scope="col">日付</th><th scope="col">問題</th><th scope="col" align="right">誤タイプ数</th><th scope="col">解答時間</th></tr>';
  //<th scope="col">response_id</th>
  a.forEach((s) => { narabi[i]=[toshiString(s.finish_at),tString(s.start_at),s.question_id,s.miss_count,worktimeString(s.start_at, s.finish_at)];
//narabi[i] += { day:toshiString(s.finish_at), mondai:m, ayamari: s.miss_count,zikan:worktimeString(s.start_at, s.finish_at) };
  i=i+1;
  });
  narabi.sort(function(a, b){
	return (a[0] < b[0] ? 1 : -1);
});
  for(var z=0;z<i;z++)
	{  let line = '<tr class="item">';
    line += '<td>' + narabi[z][0] +" "+narabi[z][1] +'</td>';
	if(narabi[z][2]==500)
	{
	line += '<td>No.1 Hello</td>';
	}
	if(narabi[z][2]==501)
	{
	line += '<td>No.2 Pangram</td>';
	}
	if(narabi[z][2]==502)
	{
	line += '<td>No.3 Even-Odd</td>';
	}
	if(narabi[z][2]==503)
	{
	line += '<td>No.4 Ten Times</td>';
	}
	if(narabi[z][2]==504)
	{
	line += '<td>No.5 Maximum</td>';
	}
	if(narabi[z][2]==505)
	{
	line += '<td>No.6 Triangle Area</td>';
	}
	if(narabi[z][2]==506)
	{
	line += '<td>No.7 Exponent</td>';
	}
    line += '<td align="right">' + narabi[z][3]+ '</td>';
    line += '<td>' + narabi[z][4]+ '</td>';
    line += '</tr>';
    table += line; 
	} 
  table += '<table></div>'
  document.getElementById('result').innerHTML =table ;
}

// "2019-09-03T13:10:00.000Z"のような文字列(UTC)を
// "2019年9月3日(火) 22時10分0秒"のような文字列(JST)に変換する
const dateString = (d) => {
  if (d == null || d == '') return null_string;
  const daytable = "日月火水木金土".split('').map((c) => `(${c})`);
  const date = new Date(d);
  return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日${daytable[date.getDay()]} ${date.getHours()}時${date.getMinutes()}分${date.getSeconds()}秒`
}
//時間のみに変更
const keikaString = (d) => {
  if (d == null || d == '') return null_string;
  const daytable = "日月火水木金土".split('').map((c) => `(${c})`);
  const date = new Date(d);
  return ` ${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}`
}


//日付表示に変更
const hiString = (d) => {
  if (d == null || d == '') return null_string;
  const daytable = "日月火水木金土".split('').map((c) => `(${c})`);
  const date = new Date(d);
  return `${date.getMonth() + 1}月${date.getDate()}日`
}
//年月日付を表示
const toshiString = (d) => {
  if (d == null || d == '') return null_string;
  const daytable = "日月火水木金土".split('').map((c) => `(${c})`);
  const date = new Date(d);
  return `${date.getFullYear()}-${('0'+(date.getMonth() + 1)).slice(-2)}-${('0'+date.getDate()).slice(-2)}`
}


const timeString = (d) => {
  if (d == null || d == '') return null_string;
  const daytable = "日月火水木金土".split('').map((c) => `(${c})`);
  const date = new Date(d);
  return ` ${date.getHours()}時${date.getMinutes()}分${date.getSeconds()}秒`
}

const tString = (d) => {
  if (d == null || d == '') return null_string;
  const daytable = "日月火水木金土".split('').map((c) => `(${c})`);
  const date = new Date(d);
  return ` ${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}`
}
// 開始時刻d1と終了時刻d2の経過時間を"4分0秒"のような文字列にする
const worktimeString = (d1, d2) => {
  if (d1 == null || d1 == '' || d2 == null || d2 == '') return null_string;
  const t1 = Date.parse(d1);
  const t2 = Date.parse(d2);
  const t12 = t2 - t1;
  let sec = Math.floor(t12 / 1000);
  const msec = t12 - sec * 1000;
  const min = Math.floor(sec / 60);
  sec -= min * 60
  return min + '分' + sec + '秒';
}

// stringをHTMLエスケープして返す
// https://qiita.com/saekis/items/c2b41cd8940923863791
const escape_html = (string) => {
  if (typeof string !== 'string') {
    return string;
  }
  return string.replace(/[&'`"<>]/g, function(match) {
    return {
      '&': '&amp;',
      "'": '&#x27;',
      '`': '&#x60;',
      '"': '&quot;',
      '<': '&lt;',
      '>': '&gt;',
    }[match]
  });
}

// question_idに基づき問題を獲得する
const getQ = () => {
  const id = document.getElementById(qid_id).value;
  if (id == null || id == '') return;
  query('/getq?id=' + id);
}

// question_id, student_idに基づき解答を開始する
const startR = async () => {
  const qid = document.getElementById(qid_id).value;
  const sid = document.getElementById(sid_id).value;
  if (qid == null || qid == '' || sid == null || sid == '') return;
  await query(`/startr?qid=${qid}&sid=${sid}`);
  const sleep = (time) => {
    return new Promise((resolve, reject) => {
      setTimeout(() => { resolve(); }, time);
    });
  };
  await sleep(100);
  if (flag_show_result) {
    document.getElementById(rid_id).value = res_data.rid;
    document.getElementById(miss_id).value = "10";
  }
}

// response_id, missに基づき解答を終了する
const endR = async () => {
  const id = document.getElementById(rid_id).value;
  const miss = document.getElementById(miss_id).value;
  const note = encodeURIComponent(document.getElementById(note_id).value || '');
  if (id == null || id == '' || miss == null || miss == '') return;
  await query(`/endr?id=${id}&miss=${miss}&note=${note}`);
  showResponseTable();
}

// res_dataに基づきすべての問題（の一部の属性）を表形式で表示する
const showQuestionForChoice = () => {
  const a = (res_data instanceof Array) ? res_data : [res_data];
  if (a.forEach) {
    let table = '<br><table border="1"><tr><th>問題</th><th>名前</th><th>difficulty</th></tr>';
    res_data.forEach((s) => {
      let line = '<tr>';
    if(s.question_id==500)
	{
	line += '<td>No.1 Hello</td>';
	}
	if(s.question_id==501)
	{
	line += '<td>No.2 Pangram</td>';
	}
	if(s.question_id==502)
	{
	line += '<td>No.3 Even-Odd</td>';
	}
	if(s.question_id==503)
	{
	line += '<td>No.4 Ten Times</td>';
	}
	if(s.question_id==504)
	{
	line += '<td>No.5 Maximum</td>';
	}
	if(s.question_id==505)
	{
	line += '<td>No.6 Triangle Area</td>';
	}
	if(s.question_id==506)
	{
	line += '<td>No.7 Exponent</td>';
	}
      line += '<td>' + s.name + '</td>';
      line += '<td>' + s.difficulty + '</td>';
      line += '</tr>';
      table += line;
    });
    table += '<table>'
    document.getElementById('result').innerHTML += table;
  }
}

// すべての問題を表示する
const showQuestion = async () => {
  await query('/show?tab=question');
  showQuestionForChoice();
}

// すべての解答を表示する
const showResponse = () => query('/show?tab=response');

// student_idに基づき解答を表示するResponsebyStudentが押されたら実行されるプログラム
const showResponseByStudent = async () => {
  const sid = document.getElementById(sid_id).value;
  if (sid == null || sid == '') return;
  await query('/resp?sid=' + sid);
  showResponseTable();
}

// res_dataに基づき解答状況を表形式で表示する




// resultを消去する
const clearResult = () => { document.getElementById('result').innerHTML = '' };

// student_idに基づき設定する
const setsid = () => {
  let sid = document.getElementById(sid_id).value;
  if (sid == null || sid == '') {
    sid = 'sid=;max-age=0'
  }
  document.cookie = `sid=${sid}`;
}

// student_idをクッキーから読み出す
const getsid = () => {
  let sid = null;
  document.cookie.split(/; */).forEach((s) => {
    const v = s.split(/=/);
    if (v[0] == 'sid') {
      sid = v[1];
    }
  })
  if (sid) document.getElementById(sid_id).value = sid;
  return sid;
}
getsid();

// question_idに基づき解答結果を取得し、Excel形式で出力する
const exportInExcelFormat = async () => {
  let qid = document.getElementById(qid_id).value
  if (qid == null || qid == '') return

  const origin = document.getElementById('origin').value.replace(/\/$/, '')
  const path = '/respbyq?qid=' + qid
  await axios({
      url: origin + path,
      method: 'GET',
      responseType: 'blob',
    })
    .then(res => {
      const url = URL.createObjectURL(new Blob([res.data]))
      const link = document.createElement('a')
      link.href = url
      link.setAttribute('download', 'response.xlsx')
      document.body.appendChild(link)
      link.click()
      URL.revokeObjectURL(url)

      console.log(res)
    })
}
const getsidAndshowQuestion = async () => {
  document.cookie.split(/; */).forEach((s) => {
    const v = s.split(/=/);
    if (v[0] == 'sid') sid = v[1];
  });
  if (sid == null) {
    if (window.confirm('学籍番号を設定していません。トップページに戻りますか？\n（キャンセルを押すと解答がサーバに記録されません。）')) {
      location.href = 'top.html';
    }
  } else {
    await query('/showsid?sid=' + sid);
  }
}


const kyou = () =>{
var hi=new Date(); 
//年・月・日・曜日を取得する
var nen = hi.getFullYear();
var tuki = ('0'+(hi.getMonth() + 1)).slice(-2);
var niti = ('0'+hi.getDate()).slice(-2);
var m=nen+'-'+tuki+'-'+niti;

 return m;
}

//今日の結果
const showResponseByDay = async () => {
  const sid = document.getElementById(sid_id).value;
  if (sid == null || sid == '') return;
  await query('/resp?sid=' + sid);
  showResponsekyouTable();
}
  const showResponsekyouTable = () => {
  clearResult()
  var z=kyou();
  var v;
const a = (res_data instanceof Array) ? res_data : [res_data];
  let table = '<div style="height:300px; width:2000px; overflow-y:scroll; overflow-:scroll;"><br><table border="1" ><tr><th scope="col"">日付<i class="fa fa-sort"></i></th><th scope="col">問題</th><th scope="col">誤タイプ数</th><th scope="col">解答時間</th></tr>';
  a.forEach((s) => 
  {
  v=toshiString(s.finish_at);
  if(v==z)
  {
    let line = '<tr class="item">';
    line += '<td>' + toshiString(s.finish_at) +" "+ tString(s.start_at)+'</td>';
	if(s.question_id==500)
	{
	line += '<td>No.1 Hello</td>';
	}
	if(s.question_id==501)
	{
	line += '<td>No.2 Pangram</td>';
	}
	if(s.question_id==502)
	{
	line += '<td>No.3 Even-Odd</td>';
	}
	if(s.question_id==503)
	{
	line += '<td>No.4 Ten Times</td>';
	}
	if(s.question_id==504)
	{
	line += '<td>No.5 Maximum</td>';
	}
	if(s.question_id==505)
	{
	line += '<td>No.6 Triangle Area</td>';
	}
	if(s.question_id==506)
	{
	line += '<td>No.7 Exponent</td>';
	}
    line += '<td align="right">' + s.miss_count + '</td>';
    line += '<td>' + worktimeString(s.start_at, s.finish_at) + '</td>';
    line += '</tr>';
    table += line;
	}
  });//sqlの中。この中に処理を書く
  table += '<table></div>'
  document.getElementById('result').innerHTML +=table;
  }
  
  
  
  
  
  //日付の検索表示
const kensaku= () =>{

showResponseBykensaku();
}
const showResponseBykensaku = async () => {
  const sid = document.getElementById(sid_id).value;
  if (sid == null || sid == '') return;
  await query('/resp?sid=' + sid);
  showResponsekensakuTable();
}
 const showResponsekensakuTable = () => {
  clearResult()
  var u=document.getElementById('sd').value;
const a = (res_data instanceof Array) ? res_data : [res_data];
  let table = '<div style="height:300px; width:2000px; overflow-y:scroll; overflow-:scroll;"><br><table border="1"><tr><th scope="col">日付</th><th scope="col">問題</th><th scope="col">誤タイプ数</th><th scope="col">解答時間</th></tr>';
  a.forEach((s) => 
  {
  var v=toshiString(s.finish_at);
  if(v==u)
  {
    let line = '<tr class="item">';
    line += '<td>' + toshiString(s.finish_at) +" "+ tString(s.start_at)+'</td>';
	if(s.question_id==500)
	{
	line += '<td>No.1 Hello</td>';
	}
	if(s.question_id==501)
	{
	line += '<td>No.2 Pangram</td>';
	}
	if(s.question_id==502)
	{
	line += '<td>No.3 Even-Odd</td>';
	}
	if(s.question_id==503)
	{
	line += '<td>No.4 Ten Times</td>';
	}
	if(s.question_id==504)
	{
	line += '<td>No.5 Maximum</td>';
	}
	if(s.question_id==505)
	{
	line += '<td>No.6 Triangle Area</td>';
	}
	if(s.question_id==506)
	{
	line += '<td>No.7 Exponent</td>';
	}
    line += '<td align="right">' + s.miss_count + '</td>';
    line += '<td>' + worktimeString(s.start_at, s.finish_at) + '</td>';
    line += '</tr>';
    table += line;
	}
	
  });//sqlの中。この中に処理を書く
  table += '<table></div>'
  document.getElementById('result').innerHTML += table;
  }
  //日付を降順に表示するテーブルを作成
   const kouzyun= () =>
	{
showResponseBykouzyun();
	}
	//sqlを取得
const showResponseBykouzyun = async () => 
	{
	const sid = document.getElementById(sid_id).value;
	if (sid == null || sid == '') return;
	await query('/resp?sid=' + sid);
	showResponsekouzyunTable();
	}
//降順のテーブルを表示
 const showResponsekouzyunTable = () => {
  clearResult()

const a = (res_data instanceof Array) ? res_data : [res_data];
  let table ='<div style="height:300px; width:2000px; overflow-y:scroll; overflow-:scroll;"><br><table border="1"><tr><th scope="col">日付</th><th scope="col">問題</th><th scope="col">誤タイプ数</th><th scope="col">解答時間</th></tr>';
  var i=0;
  var narabi=[];
  a.forEach((s) => 
  {
 narabi[i]=[toshiString(s.finish_at),tString(s.start_at),s.question_id,s.miss_count,worktimeString(s.start_at, s.finish_at)];
//narabi[i] += { day:toshiString(s.finish_at), mondai:m, ayamari: s.miss_count,zikan:worktimeString(s.start_at, s.finish_at) };
  i=i+1;
  });//sqlの中。この中に処理を書く
  narabi.sort(function(a, b){
	return (a[0] < b[0] ? 1 : -1);
});
  for(var z=0;z<3;z++)
	{  let line = '<tr class="item">';
    line += '<td>' + narabi[z][0] +" "+narabi[z][1] +'</td>';
	if(narabi[z][2]==500)
	{
	line += '<td>No.1 Hello</td>';
	}
	if(narabi[z][2]==501)
	{
	line += '<td>No.2 Pangram</td>';
	}
	if(narabi[z][2]==502)
	{
	line += '<td>No.3 Even-Odd</td>';
	}
	if(narabi[z][2]==503)
	{
	line += '<td>No.4 Ten Times</td>';
	}
	if(narabi[z][2]==504)
	{
	line += '<td>No.5 Maximum</td>';
	}
	if(narabi[z][2]==505)
	{
	line += '<td>No.6 Triangle Area</td>';
	}
	if(narabi[z][2]==506)
	{
	line += '<td>No.7 Exponent</td>';
	}
    line += '<td align="right">' + narabi[z][3]+ '</td>';
    line += '<td>' + narabi[z][4]+ '</td>';
    line += '</tr>';
    table += line; 
	} 
  table += '<table></div>'
  document.getElementById('result').innerHTML =table ;
  }
 
 
 //降順の終わり
getsid();
getsidAndshowQuestion();

document.getElementById('sid').innerHTML = sid_id;
document.getElementById('si').innerHTML = '<span>'+sid+'</span>';
document.getElementById('sid').innerHTML ="";
/*あなたの学生番号<div id="sid"></div>student_id = <input type="text" name="sid" id="sid" size="10">*/
kouzyun();
//showResponseByStudent();
todaytable();
</script>

</body> </html>
